<!DOCTYPE html>
<html lang="en">

<!--
  Copyright (C) 2019-Present Pivotal Software, Inc. All rights reserved.

  This program and the accompanying materials are made available under the terms
  of the Apache License, Version 2.0 (the "Licenseâ€); you may not use this file
  except in compliance with the License. You may obtain a copy of the License at:

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software distributed
  under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR
  CONDITIONS OF ANY KIND, either express or implied. See the License for the
  specific language governing permissions and limitations under the License.
-->

<head>
    <meta charset="UTF-8">
    <title>Skenario</title>
    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.4/css/bulma.min.css">
</head>
<body>

<div class="hero is-info">
    <div class="hero-body">
        <div class="container">
            <h1 class="title">Skenario</h1>
        </div>
    </div>
</div>

<div class="columns">
    <div class="column is-one-fifth">
        <form>
            <div class="field is-horizontal">
                <div class="field-label is-normal">
                    <label class="label" for="runFor">Run For (seconds)</label>
                </div>
                <div class="control">
                    <input type="number" style="width: 5em" id="runFor" value="180" min="1"/>
                </div>
            </div>
            <div class="field is-horizontal">
                <div class="field-label is-normal">
                    <label class="label" for="launchDelay">Replica Launch Delay (seconds)</label>
                </div>
                <div class="control">
                    <input type="number" style="width: 5em" id="launchDelay" value="5" min="0.01" step="0.1"/>
                </div>
            </div>
            <div class="field is-horizontal">
                <div class="field-label is-normal">
                    <label class="label" for="terminateDelay">Replica Terminate Delay (seconds)</label>
                </div>
                <div class="control">
                    <input type="number" style="width: 5em" id="terminateDelay" value="1" min="0.01" step="0.1"/>
                </div>
            </div>
            <div class="field is-horizontal">
                <div class="field-label is-normal">
                    <label class="label" for="tickInterval">Tick Interval (seconds)</label>
                </div>
                <div class="control">
                    <input type="number" style="width: 5em" id="tickInterval" value="2" min="1" step="1"/>
                </div>
            </div>
            <div class="field is-horizontal">
                <div class="field-label is-normal">
                    <label class="label" for="stableWindow">Stable Window (seconds)</label>
                </div>
                <div class="control">
                    <input type="number" style="width: 5em" id="stableWindow" value="60" min="1" step="1"/>
                </div>
            </div>
            <div class="field is-horizontal">
                <div class="field-label is-normal">
                    <label class="label" for="panicWindow">Panic Window (seconds)</label>
                </div>
                <div class="control">
                    <input type="number" style="width: 5em" id="panicWindow" value="6" min="1" step="1"/>
                </div>
            </div>
            <div class="field is-horizontal">
                <div class="field-label is-normal">
                    <label class="label" for="scaleToZeroGracePeriod">Scale to Zero Grace Period (seconds)</label>
                </div>
                <div class="control">
                    <input type="number" style="width: 5em" id="scaleToZeroGracePeriod" value="30" min="1" step="1"/>
                </div>
            </div>
            <div class="field is-horizontal">
                <div class="field-label is-normal">
                    <label class="label" for="targetConcurrencyDefault">Target Concurrency Default</label>
                </div>
                <div class="control">
                    <input type="number" style="width: 5em" id="targetConcurrencyDefault" value="1.0" min="0.1" step="0.1"/>
                </div>
            </div>
            <div class="field is-horizontal">
                <div class="field-label is-normal">
                    <label class="label" for="targetConcurrencyPercentage">Target Concurrency Percentage</label>
                </div>
                <div class="control">
                    <input type="number" style="width: 5em" id="targetConcurrencyPercentage" value="0.5" min="0.01" max="0.99" step="0.01"/>
                </div>
            </div>
            <div class="field is-horizontal">
                <div class="field-label is-normal">
                    <label class="label" for="maxScaleUpRate">Max Scale Up Rate</label>
                </div>
                <div class="control">
                    <input type="number" style="width: 5em" id="maxScaleUpRate" value="100.0" min="1" step="1"/>
                </div>
            </div>

            <hr>

            <div class="field is-horizontal">
                <div class="field-label is-normal">
                    <label for="select-traffic-pattern" class="label">Traffic Pattern</label>
                </div>
                <div class="control">
                    <select name="select-traffic-pattern" id="select-traffic-pattern" class="select">
                        <option value="">&mdash;</option>
                        <option value="golang_rand_uniform">Uniform</option>
                        <option value="step">Step</option>
                        <option value="ramp">Ramp</option>
                        <option value="sinusoidal">Sinusoidal</option>
                    </select>
                </div>
            </div>

            <div id="traffic-settings">
                <div id="settings-golang_rand_uniform" class="traffic-setting is-invisible">
                    <div class="field is-horizontal">
                        <div class="field-label is-normal">
                            <label class="label" for="uniformConfigNumberOfRequests">Number of Requests</label>
                        </div>
                        <div class="control">
                            <input type="number" style="width: 5em" id="uniformConfigNumberOfRequests" value="100" min="1" step="1"/>
                        </div>
                    </div>
                </div>
                <div id="settings-step" class="traffic-setting is-invisible">
                    <div class="field is-horizontal">
                        <div class="field-label is-normal">
                            <label class="label" for="stepConfigStepAfter">Step After (seconds)</label>
                        </div>
                        <div class="control">
                            <input type="number" style="width: 5em" id="stepConfigStepAfter" value="10" min="1" step="1"/>
                        </div>
                    </div>
                    <div class="field is-horizontal">
                        <div class="field-label is-normal">
                            <label class="label" for="stepConfigRPS">Step to RPS</label>
                        </div>
                        <div class="control">
                            <input type="number" style="width: 5em" id="stepConfigRPS" value="10" min="1" step="1"/>
                        </div>
                    </div>
                </div>
                <div id="settings-ramp" class="traffic-setting is-invisible">
                    <div class="field is-horizontal">
                        <div class="field-label is-normal">
                            <label class="label" for="rampConfigDeltaV">Ramp Delta V</label>
                        </div>
                        <div class="control">
                            <input type="number" style="width: 5em" id="rampConfigDeltaV" value="1" min="1" step="1"/>
                        </div>
                    </div>
                    <div class="field is-horizontal">
                        <div class="field-label is-normal">
                            <label class="label" for="rampConfigMaxRPS">Ramp Max RPS</label>
                        </div>
                        <div class="control">
                            <input type="number" style="width: 5em" id="rampConfigMaxRPS" value="50" min="1" step="1"/>
                        </div>
                    </div>
                </div>
                <div id="settings-sinusoidal" class="traffic-setting is-invisible">
                    <div class="field is-horizontal">
                        <div class="field-label is-normal">
                            <label class="label" for="sinusoidalConfigAmplitude">Amplitude (RPS)</label>
                        </div>
                        <div class="control">
                            <input type="number" style="width: 5em" id="sinusoidalConfigAmplitude" value="1" min="1" step="1"/>
                        </div>
                    </div>
                    <div class="field is-horizontal">
                        <div class="field-label is-normal">
                            <label class="label" for="sinusoidalConfigPeriod">Period (seconds)</label>
                        </div>
                        <div class="control">
                            <input type="number" style="width: 5em" id="sinusoidalConfigPeriod" value="50" min="1" step="1"/>
                        </div>
                    </div>
                </div>
            </div>


            <button class="button is-primary is-fullwidth" type="button" onclick="doRun(event); return false">Execute
                simulation
            </button>
        </form>
    </div>
    <div id="view" class="column" style="overflow: auto">
        <p id="loading"></p>
    </div>
</div>

<script>
    const trafficSelector = document.getElementById("select-traffic-pattern");

    trafficSelector.oninput = setTrafficPattern;
    let trafficPattern = "";

    function setTrafficPattern(inputEvt) {
        let newPattern = inputEvt.target.value;
        trafficPattern = newPattern;

        let trafficSettings = Array.from(document.getElementsByClassName("traffic-setting"));

        trafficSettings.forEach(function (ts) {
            ts.hidden = true;
        });
        let settingsDiv = document.getElementById("settings-" + newPattern);

        settingsDiv.hidden = false;
        settingsDiv.className = "traffic-setting";
    }

    function chart(scaleDomain, datasets) {
        const NO_TITLE = null;
        const chartWidth = 1600;
        const legend = {
            title: "Legend",
            titleOrient: "left",
            titleFontSize: 18,
            labelFontSize: 13,
            orient: "bottom-left",
            columns: 2,
            columnPadding: 50,
        };
        const rpsPlot = {
            data: {name: "requests_per_second"},
            mark: {
                type: "line",
                opacity: 0.6,
                strokeDash: [2, 2],
                color: "#a13200",
                interpolate: "linear"
            },
            encoding: {
                x: {
                    field: "second",
                    type: "quantitative",
                    title: NO_TITLE,
                    scale: {domain: scaleDomain}
                },
                y: {
                    field: "requests",
                    type: "quantitative",
                    title: "Requests Per Second"
                },
            }
        };

        return {
            $schema: "https://vega.github.io/schema/vega-lite/v3.json",
            datasets: datasets,
            vconcat: [
                {
                    height: 500,
                    width: chartWidth,
                    layer: [
                        {
                            data: {name: "tally_lines"},
                            transform: [
                                {calculate: "datum.occurs_at / 1000000000", as: "occurs_at_sec"},
                                {filter: {field: "kind_stocked", equal: "Replica"}}
                            ],
                            mark: {
                                type: "line",
                                interpolate: "step"
                            },
                            encoding: {
                                color: {
                                    field: "stock_name",
                                    type: "nominal",
                                    legend: legend
                                },
                                x: {
                                    field: "occurs_at_sec",
                                    type: "quantitative",
                                    scale: {domain: scaleDomain}
                                },
                                y: {
                                    field: "tally",
                                    type: "quantitative",
                                    title: "Replicas"
                                }
                            }
                        },
                        rpsPlot
                    ],
                    resolve: {
                        scale: {
                            color: "shared",
                            y: "independent"
                        }
                    }
                },

                {
                    height: 500,
                    width: chartWidth,
                    layer: [
                        {
                            data: {name: "tally_lines"},
                            transform: [
                                {calculate: "datum.occurs_at / 1000000000", as: "occurs_at_sec"},
                                {filter: {field: "kind_stocked", equal: "Request"}}
                            ],
                            mark: {
                                type: "line",
                                interpolate: "linear"
                            },
                            encoding: {
                                color: {
                                    field: "stock_name",
                                    type: "nominal",
                                    legend: legend
                                },
                                x: {
                                    field: "occurs_at_sec",
                                    type: "quantitative",
                                    scale: {domain: scaleDomain}
                                },
                                y: {
                                    field: "tally",
                                    type: "quantitative",
                                    title: "Requests"
                                }
                            }
                        },
                        rpsPlot
                    ],
                    resolve: {
                        scale: {
                            color: "shared",
                            y: "independent"
                        }
                    }
                },

                {
                    height: 100,
                    width: chartWidth,
                    data: {name: "response_times"},
                    transform: [
                        {calculate: "datum.completed_at / 1000000000", as: "completed_at_sec"},
                        {calculate: "datum.response_time / 1000000", as: "response_time_ms"}
                    ],
                    mark: {type: "line"},
                    encoding: {
                        x: {
                            field: "completed_at_sec",
                            type: "quantitative",
                            scale: {domain: scaleDomain},
                            title: NO_TITLE
                        },
                        y: {
                            field: "response_time_ms",
                            type: "quantitative",
                            title: "Response Time (ms)"
                        }
                    }
                }
            ]
        };
    }

    function doRun(event) {
        event.preventDefault();

        document.getElementById("loading").innerText = "Loading...";

        let runFor = parseInt(document.querySelector("input[id='runFor'").value);
        let launchDelay = parseInt(document.querySelector("input[id='launchDelay']").value);
        let terminateDelay = parseInt(document.querySelector("input[id='terminateDelay']").value);
        let tickInterval = parseInt(document.querySelector("input[id='tickInterval']").value);
        let stableWindow = parseInt(document.querySelector("input[id='stableWindow']").value);
        let panicWindow = parseInt(document.querySelector("input[id='panicWindow']").value);
        let scaleToZeroGracePeriod = parseInt(document.querySelector("input[id='scaleToZeroGracePeriod']").value);
        let targetConcurrencyDefault = parseFloat(document.querySelector("input[id='targetConcurrencyDefault']").value);
        let targetConcurrencyPercentage = parseFloat(document.querySelector("input[id='targetConcurrencyPercentage']").value);
        let maxScaleUpRate = parseFloat(document.querySelector("input[id='maxScaleUpRate']").value);


        let second = 1000000000;
        let skenarioRunRequest = {
            run_for: runFor * second,
            launch_delay: launchDelay * second,
            terminate_delay: terminateDelay * second,
            tick_interval: tickInterval * second,
            stable_window: stableWindow * second,
            panic_window: panicWindow * second,
            scale_to_zero_grace_period: scaleToZeroGracePeriod * second,
            target_concurrency_default: targetConcurrencyDefault,
            target_concurrency_percentage: targetConcurrencyPercentage,
            max_scale_up_rate: maxScaleUpRate,

            traffic_pattern: trafficPattern,
        };

        switch (trafficPattern) {
            case "golang_rand_uniform":
                let uniformConfigNumberOfRequests = parseInt(document.querySelector("input[id='uniformConfigNumberOfRequests']").value);

                skenarioRunRequest["uniform_config"] = {
                    number_of_requests: uniformConfigNumberOfRequests,
                };

                break;
            case "step":
                let stepConfigStepAfter = parseInt(document.querySelector("input[id='stepConfigStepAfter']").value);
                let stepConfigRPS = parseInt(document.querySelector("input[id='stepConfigRPS']").value);

                skenarioRunRequest["step_config"] = {
                    step_after: stepConfigStepAfter * second,
                    rps: stepConfigRPS,
                };

                break;
            case "ramp":
                let rampConfigMaxRPS = parseInt(document.querySelector("input[id='rampConfigMaxRPS']").value);
                let rampConfigDeltaV = parseInt(document.querySelector("input[id='rampConfigDeltaV']").value);

                skenarioRunRequest["ramp_config"] = {
                    delta_v: rampConfigDeltaV,
                    max_rps: rampConfigMaxRPS,
                };

                break;
            case "sinusoidal":
                let sinusoidalConfigAmplitude = parseInt(document.querySelector("input[id='sinusoidalConfigAmplitude']").value);
                let sinusoidalConfigPeriod = parseInt(document.querySelector("input[id='sinusoidalConfigPeriod']").value);

                skenarioRunRequest["sinusoidal_config"] = {
                    amplitude: sinusoidalConfigAmplitude,
                    period: sinusoidalConfigPeriod * second,
                };

                break;
        }

        let currentUrl = new URL(window.location.href);
        if (currentUrl.searchParams.get("inmemory")) {
            skenarioRunRequest.in_memory_database = true
        }

        let fetchOpts = {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(skenarioRunRequest)
        };

        fetch("http://localhost:3000/run", fetchOpts).then((response) => {
            return response.json().then((responseJson) => {
                let datasets = {
                    tally_lines: responseJson["tally_lines"],
                    response_times: responseJson["response_times"],
                    requests_per_second: responseJson["requests_per_second"]
                };

                let ranForSec = responseJson["ran_for"] / second;
                let scaleDomain = [0, ranForSec];

                vegaEmbed(
                    '#loading',
                    chart(scaleDomain, datasets),
                    {theme: 'fivethirtyeight'}
                );
            })
        });
    }
</script>
</body>
</html>
